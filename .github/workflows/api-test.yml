name: API Test Runner

on:
  # å®šæ—¶è¿è¡Œ - æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ (UTC+8 = UTC 1:00)
  schedule:
    - cron: "* * * * *"

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      runs:
        description: "è¿è¡Œæ¬¡æ•° (é»˜è®¤10æ¬¡)"
        required: false
        default: "10"
        type: string
      delay:
        description: "è¯·æ±‚é—´éš”ç§’æ•° (é»˜è®¤1ç§’)"
        required: false
        default: "1"
        type: string

jobs:
  test-api:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ”§ å®‰è£…ä¾èµ–
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: ğŸ§ª è¿è¡ŒAPIæµ‹è¯•è„šæœ¬
        run: |
          echo "ğŸš€ å¼€å§‹è¿è¡ŒAPIæµ‹è¯•..."
          echo "ğŸ“Š è¿è¡Œæ¬¡æ•°: ${{ github.event.inputs.runs || '10' }}"
          echo "â±ï¸ è¯·æ±‚é—´éš”: ${{ github.event.inputs.delay || '1' }}ç§’"
          echo ""
          node test_api_script.js
        env:
          # å¦‚æœéœ€è¦è®¤è¯tokenï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®ç¯å¢ƒå˜é‡
          # OAUTH_TOKEN: ${{ secrets.OAUTH_TOKEN }}
          # OAUTH_TOKEN_SECRET: ${{ secrets.OAUTH_TOKEN_SECRET }}
          RUNS: ${{ github.event.inputs.runs || '10' }}
          DELAY: ${{ github.event.inputs.delay || '1' }}

      - name: ğŸ“‹ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          echo "## APIæµ‹è¯•æŠ¥å‘Š ğŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "- **è¿è¡Œæ¬¡æ•°**: ${{ github.event.inputs.runs || '10' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **è¯·æ±‚é—´éš”**: ${{ github.event.inputs.delay || '1' }}ç§’" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **è¿è¡ŒçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

      # å¯é€‰ï¼šä¿å­˜æµ‹è¯•ç»“æœåˆ°artifact
      - name: ğŸ“ ä¿å­˜æµ‹è¯•æ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-logs-${{ github.run_number }}
          path: |
            *.log
          retention-days: 7
